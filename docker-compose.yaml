# Docker compose file for running the LabCAS containers:
# labcas-backend
# labcas-ui
# nginx proxy

# Required env variables: 
# LABCAS_CONFIG: location of configuration directory
# LABCAS_STAGING: location of temporary data storage
# LABCAS_ARCHIVE: location of permanent sara storage
# LABCAS_HOME: location containig solr-index directory

# Required files:
# $LABCAS_CONFIG/labcas.properties
# $LABCAS_CONFIG/labcas_certs
# $LABCAS_CONFIG/paste.cfg
# $LABCAS_CONFIG/ui.env

version: '3.3'

services:

   nginx:
     image: nginx
     #container_name: nginx
     #command: [nginx-debug, '-g', 'daemon off;']
     ports:
        - "80:80"
     volumes:
        # override default nginx configuration
        - ./nginx/conf/nginx_proxy.conf:/etc/nginx/conf.d/default.conf:ro
     depends_on:
       - labcas-backend 
       - labcas-ui

   labcas-backend: 
      image: edrn/labcas-backend:${LABCAS_BK_VERSION-latest}
      #container_name: labcas-backend
      build:
        context: ./labcas-backend
      #ports:
      #  - "8983:8983"
      #  - "9000:9000"
      #  - "9001:9001"
      #  - "8080:8080"
      volumes: 
        - $LABCAS_STAGING:/usr/local/labcas_staging
        - $LABCAS_ARCHIVE:/usr/local/labcas_archive
        - $LABCAS_HOME/solr-index:/usr/local/labcas/solr-index
        - $LABCAS_CONFIG/labcas.properties:/root/labcas.properties
        - $LABCAS_CONFIG/labcas_certs:/root/certs
        
   labcas-ui: 
      image: edrn/labcas-ui:${LABCAS_UI_VERSION-latest}
      #container_name: labcas-ui
      # build:
      #  context: ./labcas-ui
      #ports:
      #  - "6543:6543"
      env_file: $LABCAS_CONFIG/ui.env
      volumes: 
        - $LABCAS_STAGING:/usr/local/labcas_staging
        - $LABCAS_CONFIG/labcas_certs:/app/certs
        # FIXME?
        - $LABCAS_ARCHIVE:/usr/local/labcas_archive
        - $LABCAS_CONFIG/paste.cfg:/app/persistence/paste.cfg
        - persistence:/app/persistence
      depends_on:
        - labcas-backend  
      healthcheck:
            test: ["CMD", "curl", "--fail", "http://labcas-ui:6543"]
            interval: 5m
            timeout: 10s
            retries: 3

volumes:
    persistence: